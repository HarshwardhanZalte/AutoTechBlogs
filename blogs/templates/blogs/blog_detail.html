{% extends 'blogs/base.html' %}

{% block content %}
<article class="blog-post">
    <header class="blog-post-header">
        <h1>{{ blog.title }}</h1>
        <div class="blog-post-meta">
            <span>By {{ blog.author }}</span>
            <span>{{ blog.created_at|date:"F j, Y" }}</span>
        </div>
    </header>

    <img src="{{ blog.image_url|default:'https://placehold.co/1200x600/1e1e1e/00f2ff?text=Tech+News' }}" 
         alt="{{ blog.title }}" 
         class="blog-post-image"
         onerror="this.src='https://placehold.co/1200x600/1e1e1e/00f2ff?text=Image+Error'">

    <div class="blog-post-content">
        <!-- Render the generated HTML content safely -->
        {{ blog.content|safe }}

        <!-- Display Key Takeaways -->
        {% if blog.key_takeaways %}
        <div class="key-points-box">
            <h3>Key Takeaways</h3>
            <ul>
                {% for item in blog.key_takeaways %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Display Discussion Questions -->
        {% if blog.discussion_questions %}
        <div class="did-you-know-box">
            <h3>Join the Discussion</h3>
            <p>What are your thoughts? Let us know in the comments!</p>
            <ul>
                {% for item in blog.discussion_questions %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

    </div>

    <!-- Tags -->
    {% if tags_list %}
    <div class="blog-post-tags">
        <strong>Tags: </strong>
        {% for tag in tags_list %}
            <span class="tag">{{ tag }}</span>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Original Source Link -->
    <a href="{{ blog.source_url }}" class="blog-source-link" target="_blank" rel="noopener noreferrer">
        Read Original Source
    </a>
</article>

<!-- Comments Section -->
<section class="comments-section">
    <h2>Comments</h2>

    <!-- Comment Form -->
    <form id="comment-form" class="comment-form">
        <h3>Leave a Comment</h3>
        <!-- CSRF token is included for security -->
        {% csrf_token %}
        <!-- Hidden input for the blog post ID -->
        <input type="hidden" id="blog-pk" name="blog" value="{{ blog.pk }}">
        
        <div class="form-group">
            <label for="comment-name">Name</label>
            <input type="text" id="comment-name" name="name" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="comment-message">Message</label>
            <textarea id="comment-message" name="message" class="form-control" required></textarea>
        </div>
        
        <button type="submit" id="comment-submit-btn" class="btn">Post Comment</button>
        <div id="form-message" style="margin-top: 1rem;"></div>
    </form>

    <!-- Comment List -->
    <div id="comment-list">
        {% for comment in comments %}
        <div class="comment">
            <div class="comment-header">
                <strong class="comment-author">{{ comment.name }}</strong>
                <span class="comment-date">{{ comment.created_at|timesince }} ago</span>
            </div>
            <p class="comment-message">{{ comment.message|linebreaksbr }}</p>
        </div>
        {% empty %}
        <p id="no-comments">Be the first to comment!</p>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const commentForm = document.getElementById('comment-form');
    const commentSubmitBtn = document.getElementById('comment-submit-btn');
    const formMessage = document.getElementById('form-message');

    commentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        commentSubmitBtn.disabled = true;
        commentSubmitBtn.textContent = 'Posting...';
        formMessage.textContent = '';
        formMessage.style.color = 'var(--color-neon-blue)';

        // Get data from form
        const blogId = document.getElementById('blog-pk').value;
        const name = document.getElementById('comment-name').value;
        const message = document.getElementById('comment-message').value;

        // Manually create the JSON payload
        const payload = {
            blog: blogId,
            name: name,
            message: message
        };

        // 'csrftoken' is available from base.html
        fetch('/api/comments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            // Handle HTTP errors
            throw new Error('Something went wrong. Please try again.');
        })
        .then(data => {
            // Success!
            formMessage.textContent = 'Comment posted successfully!';
            formMessage.style.color = 'var(--color-neon-blue)';
            
            // Clear the form
            commentForm.reset();
            
            // Add the new comment to the top of the list
            addCommentToDOM(data);
            
            // Re-enable button
            commentSubmitBtn.disabled = false;
            commentSubmitBtn.textContent = 'Post Comment';
        })
        .catch(error => {
            // Error
            formMessage.textContent = error.message;
            formMessage.style.color = '#ff4d4d'; // A neon-ish red
            commentSubmitBtn.disabled = false;
            commentSubmitBtn.textContent = 'Post Comment';
        });
    });

    function addCommentToDOM(comment) {
        const commentList = document.getElementById('comment-list');
        const noComments = document.getElementById('no-comments');
        
        // Remove "no comments" message if it exists
        if (noComments) {
            noComments.remove();
        }

        // Create new comment element
        const commentEl = document.createElement('div');
        commentEl.className = 'comment';

        // Format date (simple "Just now")
        const date = "Just now";

        commentEl.innerHTML = `
            <div class="comment-header">
                <strong class="comment-author">${escapeHTML(comment.name)}</strong>
                <span class="comment-date">${date}</span>
            </div>
            <p class="comment-message">${escapeHTML(comment.message).replace(/\n/g, '<br>')}</p>
        `;

        // Prepend to the list
        commentList.prepend(commentEl);
    }

    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }
});
</script>
{% endblock %}